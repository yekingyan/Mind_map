<map version="freeplane 1.8.0">
<!--To view this file, download free mind mapping software Freeplane from http://freeplane.sourceforge.net -->
<node TEXT="AOI" LOCALIZED_STYLE_REF="AutomaticLayout.level.root" FOLDED="false" ID="ID_1723255651" CREATED="1283093380553" MODIFIED="1613983127503" STYLE="bubble">
<font NAME="Noto Sans S Chinese Light" SIZE="14"/>
<hook NAME="MapStyle" zoom="1.077">
    <properties fit_to_viewport="false" show_icon_for_attributes="true" show_note_icons="true" edgeColorConfiguration="#808080ff,#ff0000ff,#0000ffff,#00ff00ff,#ff00ffff,#00ffffff,#7c0000ff,#00007cff,#007c00ff,#7c007cff,#007c7cff,#7c7c00ff"/>

<map_styles>
<stylenode LOCALIZED_TEXT="styles.root_node" STYLE="oval" UNIFORM_SHAPE="true" VGAP_QUANTITY="24.0 pt">
<font NAME="Noto Sans S Chinese Light" SIZE="24"/>
<stylenode LOCALIZED_TEXT="styles.predefined" POSITION="right" STYLE="bubble" VGAP_QUANTITY="6.8999999999999995 pt">
<font NAME="Noto Sans S Chinese Light" SIZE="12"/>
<stylenode LOCALIZED_TEXT="default" ICON_SIZE="12.0 pt" COLOR="#000000" STYLE="combined" BORDER_WIDTH="3.0 px" MAX_WIDTH="10.1 cm" MIN_WIDTH="0.0 cm" VGAP_QUANTITY="6.8999999999999995 pt">
<font NAME="Noto Sans S Chinese Light" SIZE="12" BOLD="false" ITALIC="false"/>
<edge STYLE="sharp_bezier" WIDTH="7"/>
</stylenode>
<stylenode LOCALIZED_TEXT="defaultstyle.details" VGAP_QUANTITY="6.8999999999999995 pt">
<font NAME="Noto Sans S Chinese Light" SIZE="12"/>
</stylenode>
<stylenode LOCALIZED_TEXT="defaultstyle.attributes" VGAP_QUANTITY="6.8999999999999995 pt">
<font NAME="Noto Sans S Chinese Light" SIZE="12"/>
</stylenode>
<stylenode LOCALIZED_TEXT="defaultstyle.note" COLOR="#000000" BACKGROUND_COLOR="#ffffff" TEXT_ALIGN="LEFT" VGAP_QUANTITY="6.8999999999999995 pt">
<font NAME="Noto Sans S Chinese Light" SIZE="12"/>
</stylenode>
<stylenode LOCALIZED_TEXT="defaultstyle.floating" VGAP_QUANTITY="6.8999999999999995 pt">
<edge STYLE="hide_edge"/>
<cloud COLOR="#f0f0f0" SHAPE="ROUND_RECT"/>
<font NAME="Noto Sans S Chinese Light" SIZE="12"/>
</stylenode>
</stylenode>
<stylenode LOCALIZED_TEXT="styles.user-defined" POSITION="right" STYLE="bubble" VGAP_QUANTITY="6.8999999999999995 pt">
<font NAME="Noto Sans S Chinese Light" SIZE="12"/>
<stylenode LOCALIZED_TEXT="styles.ok" VGAP_QUANTITY="6.8999999999999995 pt">
<icon BUILTIN="button_ok"/>
<font NAME="Noto Sans S Chinese Light" SIZE="12"/>
</stylenode>
<stylenode LOCALIZED_TEXT="styles.needs_action" VGAP_QUANTITY="6.8999999999999995 pt">
<icon BUILTIN="messagebox_warning"/>
<font NAME="Noto Sans S Chinese Light" SIZE="12"/>
</stylenode>
<stylenode LOCALIZED_TEXT="styles.floating_node" VGAP_QUANTITY="6.8999999999999995 pt">
<edge STYLE="hide_edge"/>
<cloud COLOR="#f0f0f0" SHAPE="ROUND_RECT"/>
<font NAME="Noto Sans S Chinese Light" SIZE="12"/>
</stylenode>
<stylenode LOCALIZED_TEXT="styles.topic" COLOR="#18898b" STYLE="fork" VGAP_QUANTITY="6.8999999999999995 pt">
<font NAME="Noto Sans S Chinese Light" SIZE="12" BOLD="true"/>
</stylenode>
<stylenode LOCALIZED_TEXT="styles.subtopic" COLOR="#cc3300" STYLE="fork" VGAP_QUANTITY="6.8999999999999995 pt">
<font NAME="Noto Sans S Chinese Light" SIZE="12" BOLD="true"/>
</stylenode>
<stylenode LOCALIZED_TEXT="styles.subsubtopic" COLOR="#669900" VGAP_QUANTITY="6.8999999999999995 pt">
<font NAME="Noto Sans S Chinese Light" SIZE="12" BOLD="true"/>
</stylenode>
<stylenode LOCALIZED_TEXT="styles.connection" COLOR="#606060" STYLE="fork" VGAP_QUANTITY="6.8999999999999995 pt">
<font NAME="Noto Sans S Chinese Light" SIZE="12" BOLD="false"/>
<cloud COLOR="#f0f0f0" SHAPE="ROUND_RECT"/>
</stylenode>
<stylenode LOCALIZED_TEXT="styles.important" COLOR="#ff0000" VGAP_QUANTITY="6.8999999999999995 pt">
<icon BUILTIN="yes"/>
<font NAME="Noto Sans S Chinese Light" SIZE="12"/>
</stylenode>
<stylenode LOCALIZED_TEXT="styles.question" VGAP_QUANTITY="6.8999999999999995 pt">
<icon BUILTIN="help"/>
<font NAME="Noto Sans S Chinese Light" SIZE="12"/>
</stylenode>
<stylenode LOCALIZED_TEXT="styles.key" COLOR="#996600" VGAP_QUANTITY="6.8999999999999995 pt">
<icon BUILTIN="password"/>
<font NAME="Noto Sans S Chinese Light" SIZE="12" BOLD="false"/>
</stylenode>
<stylenode LOCALIZED_TEXT="styles.idea" VGAP_QUANTITY="6.8999999999999995 pt">
<icon BUILTIN="idea"/>
<font NAME="Noto Sans S Chinese Light" SIZE="12"/>
</stylenode>
<stylenode LOCALIZED_TEXT="styles.note" COLOR="#990000" VGAP_QUANTITY="6.8999999999999995 pt">
<font NAME="Noto Sans S Chinese Light" SIZE="12"/>
</stylenode>
<stylenode LOCALIZED_TEXT="styles.date" COLOR="#0033ff" VGAP_QUANTITY="6.8999999999999995 pt">
<icon BUILTIN="calendar"/>
<font NAME="Noto Sans S Chinese Light" SIZE="12"/>
</stylenode>
<stylenode LOCALIZED_TEXT="styles.website" COLOR="#006633" VGAP_QUANTITY="6.8999999999999995 pt">
<font NAME="Noto Sans S Chinese Light" SIZE="12"/>
</stylenode>
<stylenode LOCALIZED_TEXT="styles.list" COLOR="#cc6600" VGAP_QUANTITY="6.8999999999999995 pt">
<icon BUILTIN="list"/>
<font NAME="Noto Sans S Chinese Light" SIZE="12" BOLD="true"/>
</stylenode>
<stylenode LOCALIZED_TEXT="styles.quotation" COLOR="#338800" STYLE="fork" VGAP_QUANTITY="6.8999999999999995 pt">
<font NAME="Noto Sans S Chinese Light" SIZE="12" BOLD="false" ITALIC="false"/>
</stylenode>
<stylenode LOCALIZED_TEXT="styles.definition" COLOR="#666600" VGAP_QUANTITY="6.8999999999999995 pt">
<font NAME="Noto Sans S Chinese Light" SIZE="12" BOLD="false"/>
</stylenode>
<stylenode LOCALIZED_TEXT="styles.description" COLOR="#996600" VGAP_QUANTITY="6.8999999999999995 pt">
<font NAME="Noto Sans S Chinese Light" SIZE="12" BOLD="false"/>
</stylenode>
<stylenode LOCALIZED_TEXT="styles.pending" COLOR="#b3b95c" VGAP_QUANTITY="6.8999999999999995 pt">
<font NAME="Noto Sans S Chinese Light" SIZE="12"/>
</stylenode>
<stylenode TEXT="代码" COLOR="#c0fdce" BACKGROUND_COLOR="#000000" VGAP_QUANTITY="6.8999999999999995 pt">
<font NAME="Noto Sans S Chinese Light" SIZE="12"/>
</stylenode>
</stylenode>
<stylenode LOCALIZED_TEXT="styles.AutomaticLayout" POSITION="right" STYLE="bubble" VGAP_QUANTITY="6.8999999999999995 pt">
<font NAME="Noto Sans S Chinese Light" SIZE="12"/>
<stylenode LOCALIZED_TEXT="AutomaticLayout.level.root" COLOR="#000000" STYLE="oval" VGAP_QUANTITY="6.8999999999999995 pt">
<font NAME="Noto Sans S Chinese Light" SIZE="12"/>
<edge COLOR="#003333"/>
</stylenode>
<stylenode LOCALIZED_TEXT="AutomaticLayout.level,1" COLOR="#0033ff" VGAP_QUANTITY="6.8999999999999995 pt">
<font NAME="Noto Sans S Chinese Light" SIZE="12"/>
<edge COLOR="#808080"/>
</stylenode>
<stylenode LOCALIZED_TEXT="AutomaticLayout.level,2" COLOR="#003366" VGAP_QUANTITY="6.8999999999999995 pt">
<font NAME="Noto Sans S Chinese Light" SIZE="12"/>
<edge COLOR="#808080"/>
</stylenode>
<stylenode LOCALIZED_TEXT="AutomaticLayout.level,3" COLOR="#990000" VGAP_QUANTITY="6.8999999999999995 pt">
<font NAME="Noto Sans S Chinese Light" SIZE="12"/>
</stylenode>
<stylenode LOCALIZED_TEXT="AutomaticLayout.level,4" COLOR="#111111" VGAP_QUANTITY="6.8999999999999995 pt">
<font NAME="Noto Sans S Chinese Light" SIZE="12"/>
</stylenode>
<stylenode LOCALIZED_TEXT="AutomaticLayout.level,5" COLOR="#006666" VGAP_QUANTITY="6.8999999999999995 pt">
<font NAME="Noto Sans S Chinese Light" SIZE="12"/>
</stylenode>
<stylenode LOCALIZED_TEXT="AutomaticLayout.level,6" VGAP_QUANTITY="6.8999999999999995 pt">
<font SIZE="12"/>
</stylenode>
</stylenode>
</stylenode>
</map_styles>
</hook>
<hook NAME="AutomaticEdgeColor" COUNTER="104" RULE="ON_BRANCH_CREATION"/>
<hook NAME="accessories/plugins/AutomaticLayout.properties" VALUE="ALL"/>
<node TEXT="概念" POSITION="right" ID="ID_1235284987" CREATED="1611025808868" MODIFIED="1613983154978">
<edge COLOR="#7c007c"/>
<node TEXT=" AOI（area of interest）主要解决游戏中多人同屏的问题" ID="ID_386981786" CREATED="1611025826732" MODIFIED="1611025835579"/>
<node TEXT=" AOI系统支持任何游戏世界中的物体个体对一定半径范围内发生的事件进行处理" ID="ID_1855134036" CREATED="1613983283167" MODIFIED="1613983285049"/>
<node TEXT=" MMOPRG上绝大多数需求只是对半径范围内发生的物体离开/进入事件进行处理" ID="ID_1614935609" CREATED="1613983586127" MODIFIED="1613983587657"/>
<node TEXT=" AOI实现方案的好坏直接决定了服务器能够承载的同时在线人数上限" ID="ID_427241733" CREATED="1613983514240" MODIFIED="1613983515548"/>
</node>
<node TEXT="用途" POSITION="right" ID="ID_1159032963" CREATED="1614061842725" MODIFIED="1614061845498">
<edge COLOR="#0000ff"/>
<node TEXT=" 解决 NPC 的 AI 事件触发问题" ID="ID_6910407" CREATED="1614061867171" MODIFIED="1614061868616">
<node TEXT=" NPC 的 AI 触发条件往往是和其它 NPC 或 PC 距离接近" ID="ID_1042938020" CREATED="1614061887153" MODIFIED="1614061888799"/>
<node TEXT=" 没有 AOI 模块，每个 NPC 都需要遍历场景中其它对象，判断与之距离。这个检索量是非常巨大的（复杂度 O(n^2) ）" ID="ID_1271322689" CREATED="1614061904042" MODIFIED="1614063529304"/>
<node TEXT="  AOI 模块，统一处理，并优化比较次数，当两个对象距离接近时，以消息的形式通知它们" ID="ID_1233648480" CREATED="1614061922266" MODIFIED="1614061923390"/>
</node>
<node TEXT=" 减少向 PC 发送的同步消息数量" ID="ID_367819419" CREATED="1614061963402" MODIFIED="1614061964329">
<node TEXT=" 把离 PC 较远的物体状态变化的消息过滤掉" ID="ID_1913405957" CREATED="1614061974825" MODIFIED="1614061976099"/>
<node TEXT=" PC 身上可以带一个附近对象列表，由 AOI 消息来增减这个列表的内容" ID="ID_1819269248" CREATED="1614061976721" MODIFIED="1614062109455"/>
</node>
</node>
<node TEXT=" 每个对象需要维护到两个集合" POSITION="right" ID="ID_1595814827" CREATED="1614064389516" MODIFIED="1614064390964">
<edge COLOR="#00ffff"/>
<node TEXT=" 观察者集合" ID="ID_1403611177" CREATED="1614064399732" MODIFIED="1614064401182">
<node TEXT=" 能看到我的对象集合" ID="ID_472436602" CREATED="1614064418668" MODIFIED="1614064426694"/>
<node TEXT=" 我的所有AOI行为都需要向这个集合发送事件，以便让他们观察到我的变化" ID="ID_1358605450" CREATED="1614064438124" MODIFIED="1614064439242"/>
</node>
<node TEXT=" 被观察者集合" ID="ID_1080388948" CREATED="1614064445188" MODIFIED="1614064446252">
<node TEXT=" 被我看到的对象集合" ID="ID_3260292" CREATED="1614064458043" MODIFIED="1614064464997"/>
</node>
<node TEXT="例子" ID="ID_77350592" CREATED="1614064683657" MODIFIED="1614064686149">
<node TEXT=" 假设场景中有玩家，怪物，NPC，掉落物" ID="ID_1764783515" CREATED="1614064697138" MODIFIED="1614064698292"/>
<node TEXT=" 玩家" ID="ID_802570663" CREATED="1614064714626" MODIFIED="1614065115165">
<node TEXT="观察者集合" ID="ID_1041603244" CREATED="1614064776129" MODIFIED="1614064793963">
<node TEXT=" 被其他玩家和怪物观察着" ID="ID_1782303773" CREATED="1614065014279" MODIFIED="1614065022017"/>
<node TEXT=" 不会被NPC和掉落物观察" ID="ID_1992942266" CREATED="1614065022472" MODIFIED="1614065025446"/>
</node>
<node TEXT="被观察者集合" ID="ID_1003402938" CREATED="1614064739185" MODIFIED="1614064757948">
<node TEXT="包含所有类型" ID="ID_1075700294" CREATED="1614064758825" MODIFIED="1614064773170"/>
<node TEXT=" 它能观察到所有类型的游戏对象" ID="ID_1818219789" CREATED="1614064729555" MODIFIED="1614064731629"/>
</node>
</node>
<node TEXT="NPC和掉落物" ID="ID_1182852280" CREATED="1614065043711" MODIFIED="1614065112803">
<node TEXT="观察者集合" ID="ID_1148226273" CREATED="1614064776129" MODIFIED="1614064793963">
<node TEXT="只有玩家类型" ID="ID_974925592" CREATED="1614065014279" MODIFIED="1614065097658"/>
</node>
<node TEXT="被观察者集合" ID="ID_347614767" CREATED="1614064739185" MODIFIED="1614064757948">
<node TEXT="没有" ID="ID_1112489122" CREATED="1614064758825" MODIFIED="1614065062904"/>
<node TEXT=" 它不关心周围的对象" ID="ID_1308039729" CREATED="1614064729555" MODIFIED="1614065073005"/>
</node>
</node>
<node TEXT=" 怪物" ID="ID_540229001" CREATED="1614065107335" MODIFIED="1614065108318">
<node TEXT=" 主动怪的被观察者集合是玩家；观察者集合也是玩家。" ID="ID_363542851" CREATED="1614065131598" MODIFIED="1614065132616"/>
<node TEXT="  被动怪可以设计为没有被观察者集合，因为在它没有被玩家攻击之前，它是不关心周围的环境，玩家攻击它之后，玩家会进入它的仇恨者列表，这是怪物AI的范畴了；它的观察者集合是玩家。" ID="ID_1627666985" CREATED="1614065149735" MODIFIED="1614065150821"/>
</node>
</node>
<node TEXT="算法考虑因素" ID="ID_1240914946" CREATED="1614065216214" MODIFIED="1614065224280">
<node TEXT=" 对象视野的大小，这直接影响到集合的大小" ID="ID_918516138" CREATED="1614065231454" MODIFIED="1614065232494"/>
<node TEXT=" 对象集合保存在哪里" ID="ID_478718040" CREATED="1614065233143" MODIFIED="1614065247804">
<node TEXT=" 有些做法是场景共享对象集合" ID="ID_807854673" CREATED="1614065254023" MODIFIED="1614065254946"/>
<node TEXT=" 有些则是每个对象单独保存这两个集合" ID="ID_1471915203" CREATED="1614065259213" MODIFIED="1614065260189"/>
</node>
<node TEXT=" 在进入离开移动等事件中，如何更新对象集合" ID="ID_1949883463" CREATED="1614065266214" MODIFIED="1614065267242"/>
</node>
</node>
<node TEXT="AOI算法" POSITION="right" ID="ID_338248591" CREATED="1611025845555" MODIFIED="1614066794218">
<edge COLOR="#7c007c"/>
<node TEXT=" 上帝视角" ID="ID_1025458884" CREATED="1614066836207" MODIFIED="1614066837501">
<node TEXT="把整个场景当成可见范围，无论我走到哪里，都能看到场景中的所有对象" ID="ID_613567814" CREATED="1614066868542" MODIFIED="1614066871544"/>
<node TEXT="全部玩家信息同步，O(n^2)的复杂度" ID="ID_505075885" CREATED="1613983651718" MODIFIED="1614066857392"/>
<node TEXT=" 对于几十人以下地图的特殊需求是个简洁的方案" ID="ID_647214530" CREATED="1613983689414" MODIFIED="1614067341542"/>
<node TEXT="实现细节" ID="ID_787200968" CREATED="1614067261069" MODIFIED="1614067266854">
<node TEXT=" 场景管理器只需用一个字典保存所有游戏对象，另有一个字典按对象类型保存对象集合就可以了。被观察者集合和观察者集合在需要的时候直接从场景管理器中取" ID="ID_605756336" CREATED="1614067381237" MODIFIED="1614067382508"/>
<node TEXT="进入" ID="ID_160209201" CREATED="1614066979695" MODIFIED="1614066983352">
<node TEXT=" 我进入场景需要看到场景中的所有对象。因此其它所有对象，向我发送Enter(对象)事件" ID="ID_1981333382" CREATED="1614066999110" MODIFIED="1614067064719"/>
<node TEXT=" 将我加入场景管理器" ID="ID_1366284472" CREATED="1614067052437" MODIFIED="1614067075610"/>
<node TEXT="其他对象需要看到我进入场景。因此向它们一个个发送Enter(我)" ID="ID_1000067551" CREATED="1614067083495" MODIFIED="1614067111404"/>
<node TEXT=" 可能不需要向怪物集合发送Enter消息，因为怪物AI会自己去遍历敌人" ID="ID_1095985698" CREATED="1614067136383" MODIFIED="1614067137573"/>
</node>
<node TEXT=" 离开" ID="ID_1922301904" CREATED="1614066984038" MODIFIED="1614067143670">
<node TEXT=" 我离开场景，将我从场景管理器删除" ID="ID_521520145" CREATED="1614067158566" MODIFIED="1614067159559"/>
<node TEXT="取出玩家集合，向它们一个个发送Leave(我)事件，玩家会向它的客户端发送我离开的协议" ID="ID_560037219" CREATED="1614067171806" MODIFIED="1614067181234"/>
<node TEXT=" 可能不需要向我发送Leave(对象)事件，因为我跳场景后，客户端会自动把场景中的对象删除" ID="ID_1696008612" CREATED="1614067191726" MODIFIED="1614067192677"/>
</node>
<node TEXT="更新" ID="ID_549008898" CREATED="1614067195758" MODIFIED="1614067197847">
<node TEXT=" 我在场景中的行为称为更新，比如移动，换装，发技能等等，其他玩家应该能看到我这些行为" ID="ID_646130480" CREATED="1614067207797" MODIFIED="1614067209522"/>
<node TEXT=" 取出玩家集合，向它们发送相应的事件" ID="ID_730816602" CREATED="1614067253246" MODIFIED="1614067254403"/>
</node>
</node>
</node>
<node TEXT=" 有限视野" ID="ID_214779354" CREATED="1614067440573" MODIFIED="1614067763485">
<node TEXT=" 一旦限定了对象的视野，AOI算法就开始变得复杂" ID="ID_1068466501" CREATED="1614067446317" MODIFIED="1614067447637"/>
<node TEXT=" 而且每个对象需要维护被观察者集合和观察者集合，内存占用会大大增加" ID="ID_147497226" CREATED="1614067448214" MODIFIED="1614067453388"/>
<node TEXT=" 每种对象的视野可以不同" ID="ID_1762706851" CREATED="1614067472212" MODIFIED="1614067473170">
<node TEXT=" 玩家的视野只比一个屏幕大一点点" ID="ID_380999707" CREATED="1614067493964" MODIFIED="1614067495211"/>
<node TEXT=" NPC可能视野为0，视野为0的对象不关注别人，只被别人关注" ID="ID_1115858380" CREATED="1614067484349" MODIFIED="1614067485399"/>
</node>
<node TEXT="实现细节" ID="ID_1453385381" CREATED="1614067511900" MODIFIED="1614067516318">
<node TEXT="进入" ID="ID_1022257744" CREATED="1614067521532" MODIFIED="1614067523383">
<node TEXT="我进入场景，遍历场景中所有对象，逐一比较它们和我的距离" ID="ID_1208501863" CREATED="1614067550028" MODIFIED="1614067559792"/>
<node TEXT=" 如果对象在我的视野之内，则向我发送Enter(对象)事件，此时这些对象会加入我的被观察者集合，同时，我会加入到这些对象的观察者集合" ID="ID_791627344" CREATED="1614067570861" MODIFIED="1614067571803"/>
<node TEXT=" 如果距离小于对象的视野，则向对象发送Enter(我)事件，此时我会加入到对象的被观察者集合，同时对象会加入到我的观察者集合" ID="ID_1247746168" CREATED="1614067595828" MODIFIED="1614067597590"/>
</node>
<node TEXT=" 离开" ID="ID_1870379194" CREATED="1614067604301" MODIFIED="1614067605293">
<node TEXT=" 我离开场景，遍历我的观察者集合，向他们发送Leave(我)事件，此时我从对象的被观察者集合中删除" ID="ID_672767730" CREATED="1614067611588" MODIFIED="1614067708598"/>
<node TEXT=" 我的被观察者集合清空" ID="ID_319107720" CREATED="1614067709044" MODIFIED="1614067710474"/>
</node>
<node TEXT="更新" ID="ID_850570063" CREATED="1614067714468" MODIFIED="1614067716373">
<node TEXT=" 这里的更新不包括移动，因为移动会导致对象集合变化" ID="ID_320415947" CREATED="1614067735773" MODIFIED="1614067737087"/>
<node TEXT=" 遍历我的观察者集合，向它们发送相应的更新事件。" ID="ID_1616536743" CREATED="1614067737468" MODIFIED="1614067745070"/>
</node>
<node TEXT=" 移动" ID="ID_329215036" CREATED="1614067751540" MODIFIED="1614067752707">
<node TEXT=" 我移动的时候，被观察者集合和观察者集合都会发生变动，因此会遍历场景的所有对象" ID="ID_188871050" CREATED="1614067780764" MODIFIED="1614067869653"/>
<node TEXT="  如果它原来在我的被观察者集合中，并且现在的距离已经大于我的视野，向我发送Leave(对象)事件，此时对象会从我的被观察者集合删除，同时我会从对象的观察者集合删除。" ID="ID_1960681245" CREATED="1614067870500" MODIFIED="1614067892898"/>
<node TEXT="  如果它原来在我的观察者集合中，并且现在的距离已经大于它的视野，则向它发送Leave(我)事件，此时我会从它的被观察者集合中删除，同时它会从我的观察者集合中删除。" ID="ID_1364509619" CREATED="1614067893995" MODIFIED="1614067914136"/>
<node TEXT=" 向剩下的观察者集合发送移动事件" ID="ID_708017562" CREATED="1614067925867" MODIFIED="1614067926974"/>
<node TEXT="  如果它原来没有在我的被观察者集合中，并且现在的距离已经小于等于我的视野，向我发送Enter(对象)事件，此时这些对象会加入我的被观察者集合，同时，我会加入到这些对象的观察者集合。" ID="ID_585863397" CREATED="1614067947069" MODIFIED="1614067948381"/>
<node TEXT="  如果它原来没有在我的观察者集合中，并且现在的距离已经小于等于它的视野，向它发送Enter(我)事件，此时我会加入到对象的被观察者集合，同时对象会加入到我的观察者集合。" ID="ID_588137317" CREATED="1614067950460" MODIFIED="1614067959289"/>
</node>
</node>
<node TEXT=" 移动是最大的性能瓶颈，每次移动需遍历场景中的所有对象" ID="ID_1071310426" CREATED="1614067986987" MODIFIED="1614067988100"/>
<node TEXT=" 将场景划分格子，可减少对象的遍历" ID="ID_1024164089" CREATED="1614068047779" MODIFIED="1614068056701"/>
</node>
<node TEXT="网格法" ID="ID_26921901" CREATED="1613983710582" MODIFIED="1613983714434">
<node TEXT=" 场景划分" ID="ID_629050424" CREATED="1614068234474" MODIFIED="1614068235586">
<node TEXT="" ID="ID_19846135" CREATED="1614068249922" MODIFIED="1614068253558">
<hook URI="AOI_files/png_2305458285701913901.png" SIZE="0.7542762" NAME="ExternalObject"/>
</node>
<node TEXT="将场景划分成等大的格子，1个格子大约为1/4屏幕大小" ID="ID_281953138" CREATED="1614068200563" MODIFIED="1614068213681"/>
<node TEXT=" 每个进来的对象根据坐标加入对应的格子中" ID="ID_1943868285" CREATED="1614068208850" MODIFIED="1614068210062"/>
<node TEXT=" 绿色框为屏幕大小，红星为我" ID="ID_33453481" CREATED="1614068294987" MODIFIED="1614068296170"/>
<node TEXT=" 把最大视野限定为9宫格，这样搜索范围就缩小为9个格子，需要遍历的对象数量大大减少" ID="ID_475618573" CREATED="1614068304667" MODIFIED="1614068305846"/>
</node>
<node TEXT="进入" ID="ID_385586082" CREATED="1614068311756" MODIFIED="1614068314940">
<node TEXT=" 我进入场景，马上计算出我所在的格子，并加入这个格子" ID="ID_1870963250" CREATED="1614068321339" MODIFIED="1614068322381"/>
<node TEXT=" 接下来的做法和上面的进入完全一样，只不过搜索的范围变成这9个宫格子" ID="ID_1364620182" CREATED="1614068335042" MODIFIED="1614068335972"/>
</node>
<node TEXT="离开" ID="ID_1159624491" CREATED="1614068345370" MODIFIED="1614068346948">
<node TEXT=" 我离开场景，将我从格子删除" ID="ID_1657137109" CREATED="1614068342811" MODIFIED="1614068344468"/>
<node TEXT=" 接下来的做法和上面的离开完全一样" ID="ID_730997151" CREATED="1614068351100" MODIFIED="1614068357274"/>
</node>
<node TEXT="移动" ID="ID_1604777776" CREATED="1614068362122" MODIFIED="1614068366164">
<node TEXT=" 我移动的时候，遍历9宫格的所有对象，然后执行和上面的移动完全一样的逻辑" ID="ID_448477849" CREATED="1614068375020" MODIFIED="1614068375902"/>
<node TEXT=" 如果我移动到新的格子上时" ID="ID_352182594" CREATED="1614068376466" MODIFIED="1614068387196">
<node TEXT=" 把我从原来的格子删除，加入新的格子" ID="ID_603585162" CREATED="1614068391570" MODIFIED="1614068392358"/>
<node TEXT=" 假设旧的9宫格为OldGrid，新的9宫格为NewGrid，计算{NewGrid-OldGrid}集合，得到的这些格子即为新增的格子" ID="ID_131664330" CREATED="1614068408811" MODIFIED="1614068411066"/>
<node TEXT=" 对这些格子执行和进入完全一样的处理" ID="ID_960038056" CREATED="1614068420138" MODIFIED="1614068421209"/>
</node>
</node>
<node TEXT=" 如果对象均匀的分布在场景中，且场景足够大，那这个优化的效果是非常显著的" ID="ID_1198430201" CREATED="1614068430370" MODIFIED="1614068431925"/>
<node TEXT=" 如果像主城那样，玩家大多集中在一个区域，服务器的压力仍然会很大，原因是9个格子的玩家可能占了场景80%的玩家" ID="ID_628050594" CREATED="1614068460042" MODIFIED="1614068461087"/>
</node>
<node ID="ID_220782970" CREATED="1611025859390" MODIFIED="1611025859390"><richcontent TYPE="NODE">

<html>
  <head>
    
  </head>
  <body>
    <p>
      九宫格
    </p>
  </body>
</html>
</richcontent>
<node TEXT=" 低配版网格法，强制对象的视野固定在9宫格上" ID="ID_1773164043" CREATED="1614068607417" MODIFIED="1614068721676"/>
<node TEXT=" 进入" ID="ID_875276000" CREATED="1614068887666" MODIFIED="1614068889772">
<node TEXT=" 进入一个格子" ID="ID_1807806535" CREATED="1614068900473" MODIFIED="1614068926837"/>
<node TEXT=" 取出周围9格的对象，向它们发送Enter(我)事件，同时向我发送Enter(对象)事件" ID="ID_918609144" CREATED="1614068922097" MODIFIED="1614068923130"/>
</node>
<node TEXT=" 离开" ID="ID_1121351948" CREATED="1614068910593" MODIFIED="1614068911679">
<node TEXT=" 取出周围9格的对象，向它们发送Leave(我)事件" ID="ID_1451137487" CREATED="1614068936050" MODIFIED="1614068937332"/>
</node>
<node TEXT=" 移动" ID="ID_667469124" CREATED="1614068943513" MODIFIED="1614068944359">
<node TEXT="" ID="ID_1334518496" CREATED="1614068735680" MODIFIED="1614068740062">
<hook URI="AOI_files/png_8779795588269050155.png" SIZE="0.64122397" NAME="ExternalObject"/>
</node>
<node TEXT=" 如果没跨格子，直接取9格的对象，向它们发送移动事件" ID="ID_1134363532" CREATED="1614068949009" MODIFIED="1614068955344"/>
<node TEXT="  如果跨过格子，计算{OldGrid-NewGrid}，向它们发送Leave(我)事件，向我发送Leave(对象)事件；计算{NewGrid-OldGrid}集合，向它们发送Enter(我)事件，向我发送Enter(对象事件；计算{NewGrid*OldGrid}集合，向他们发送移动事件" ID="ID_379987320" CREATED="1614068955802" MODIFIED="1614068970047"/>
</node>
<node TEXT=" 如果我们对视野要求不那么高，这个做法和上帝视角一样简单可靠" ID="ID_1714945546" CREATED="1614068993368" MODIFIED="1614068994308"/>
<node TEXT=" 缺点是客户端会收到一些屏幕外的对象消息，有点浪费带宽" ID="ID_1535423303" CREATED="1614758315161" MODIFIED="1614758316819"/>
</node>
<node ID="ID_1376537889" CREATED="1611025859391" MODIFIED="1611025859391"><richcontent TYPE="NODE">

<html>
  <head>
    
  </head>
  <body>
    <p>
      十字链表
    </p>
  </body>
</html>
</richcontent>
<node TEXT=" 场景维护着两个双向链表（如果3D空间，则增加第3条），分别对应着 X 轴 和 Y 轴" ID="ID_461849596" CREATED="1614071980667" MODIFIED="1614071982149"/>
<node TEXT=" 用十字链表，其核心思想是将所有对象结点链接在两个链表上，一个按X值排序，一个按Y值排序" ID="ID_1463795233" CREATED="1614069037490" MODIFIED="1614069038646"/>
<node TEXT=" 每个链表对象的坐标按从小到大排列，也就是 X 坐标值越小，排在越前面，Y轴同理" ID="ID_224497814" CREATED="1614072011906" MODIFIED="1614072013298"/>
<node TEXT=" 对象进入场景后遍历两个链表，找到合适的位置插进去" ID="ID_619795667" CREATED="1614069045801" MODIFIED="1614069046814"/>
<node TEXT=" 移动的时候，从对象位置前后遍历两个链表，和其他对象进行判断" ID="ID_1339079485" CREATED="1614069055673" MODIFIED="1614069056858"/>
</node>
<node ID="ID_1074187464" CREATED="1611025859395" MODIFIED="1611025859395"><richcontent TYPE="NODE">

<html>
  <head>
    
  </head>
  <body>
    <p>
      六边形网格
    </p>
  </body>
</html>
</richcontent>
</node>
</node>
<node TEXT=" AOI 的传统实现方法" POSITION="right" ID="ID_914414227" CREATED="1614062135616" MODIFIED="1614062136897">
<edge COLOR="#00ff00"/>
<node TEXT=" 直接定期比较所有对象间的关系" ID="ID_1501967178" CREATED="1614062152473" MODIFIED="1614062350835">
<node TEXT="实现" ID="ID_222323153" CREATED="1614062384641" MODIFIED="1614062396826">
<node TEXT="定时遍历检测对象间的关系" ID="ID_1480036229" CREATED="1614062400176" MODIFIED="1614062424242"/>
<node TEXT=" 发现能够触发 AOI 事件就发送消息" ID="ID_781603681" CREATED="1614062351672" MODIFIED="1614062352870"/>
</node>
<node TEXT=" 这种方案实现起来相当简洁，几乎不可能有 bug ，可以用来验证服务协议的正确性" ID="ID_940485951" CREATED="1614062155737" MODIFIED="1614062170567"/>
<node TEXT=" 在场景中对象不多的情况下其实也是不错的一个方案" ID="ID_1474852157" CREATED="1614062187137" MODIFIED="1614062192818"/>
<node TEXT=" 如果独立出来的话，利用一个单独的核，其实可以定期处理相当大的对象数量" ID="ID_1727112830" CREATED="1614062203913" MODIFIED="1614062209278"/>
</node>
<node TEXT=" 空间切割监视的方法" ID="ID_1296634042" CREATED="1614062339336" MODIFIED="1614062340672">
<node TEXT="实现" ID="ID_1056630061" CREATED="1614062425933" MODIFIED="1614062427737">
<node TEXT=" 把场景划分为等大的格子，在每个格子里树立灯塔" ID="ID_1395758878" CREATED="1614062434568" MODIFIED="1614062435589"/>
<node TEXT=" 在对象进入或退出格子时，维护每个灯塔上的对象列表" ID="ID_1946509990" CREATED="1614062441656" MODIFIED="1614062443108"/>
</node>
<node TEXT=" 对于每个灯塔还是 O(N * N) 的复杂度，但由于把对象数据量大量降了下来，所以性能要好的多，实现也很容易" ID="ID_1216965340" CREATED="1614062453801" MODIFIED="1614062457538"/>
<node TEXT="存储空间不仅和对象数量有关，还和场景大小有关。更浪费内存" ID="ID_226998586" CREATED="1614062470568" MODIFIED="1614062492019"/>
<node TEXT=" 当场景规模大过对象数量规模时，性能还会下降。因为要遍历整个场景" ID="ID_1666537378" CREATED="1614062486386" MODIFIED="1614062487637"/>
<node TEXT=" 对大地图不太合适" ID="ID_604407751" CREATED="1614062498896" MODIFIED="1614062500163"/>
</node>
<node TEXT=" 十字链表" ID="ID_1518835732" CREATED="1614062506112" MODIFIED="1614062516485">
<node TEXT=" 实现" ID="ID_1576442103" CREATED="1614062516833" MODIFIED="1614062536601">
<node TEXT=" 十字链表 (3d 空间则再增加一个链表维度) 保存一系列线段" ID="ID_449855109" CREATED="1614062555641" MODIFIED="1614062556903"/>
<node TEXT=" 当线段移动时触发 AOI 事件" ID="ID_162098360" CREATED="1614062564016" MODIFIED="1614062564926"/>
</node>
<node TEXT=" 优点是可以混用于不同半径的 AOI 区域" ID="ID_1187992828" CREATED="1614062572728" MODIFIED="1614062573680"/>
</node>
</node>
<node TEXT="" POSITION="right" ID="ID_1676670423" CREATED="1614062337514" MODIFIED="1614062337516">
<edge COLOR="#ff00ff"/>
</node>
<node TEXT="处理超远范围可视" POSITION="right" ID="ID_735697099" CREATED="1613983530103" MODIFIED="1613983552616">
<edge COLOR="#ff0000"/>
<node TEXT=" AOI搜寻到的列表一般与距离有关，增加关注列表可找出远方的目标" ID="ID_13671138" CREATED="1611026518337" MODIFIED="1613983554628"/>
<node TEXT=" 根据玩家状态加个关注列表，用来处理正在与玩家互动的npc超出显示范围的问题" ID="ID_776923972" CREATED="1611026421419" MODIFIED="1613983553830"/>
</node>
</node>
</map>
