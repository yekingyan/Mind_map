<map version="freeplane 1.8.0">
<!--To view this file, download free mind mapping software Freeplane from http://freeplane.sourceforge.net -->
<node TEXT="MMO服务器架构" LOCALIZED_STYLE_REF="AutomaticLayout.level.root" FOLDED="false" ID="ID_1723255651" CREATED="1283093380553" MODIFIED="1611558870811" STYLE="bubble">
<font NAME="Noto Sans S Chinese Light" SIZE="14"/>
<hook NAME="MapStyle" zoom="1.077">
    <properties fit_to_viewport="false" show_icon_for_attributes="true" show_note_icons="true" edgeColorConfiguration="#808080ff,#ff0000ff,#0000ffff,#00ff00ff,#ff00ffff,#00ffffff,#7c0000ff,#00007cff,#007c00ff,#7c007cff,#007c7cff,#7c7c00ff"/>

<map_styles>
<stylenode LOCALIZED_TEXT="styles.root_node" STYLE="oval" UNIFORM_SHAPE="true" VGAP_QUANTITY="24.0 pt">
<font NAME="Noto Sans S Chinese Light" SIZE="24"/>
<stylenode LOCALIZED_TEXT="styles.predefined" POSITION="right" STYLE="bubble" VGAP_QUANTITY="6.8999999999999995 pt">
<font NAME="Noto Sans S Chinese Light" SIZE="12"/>
<stylenode LOCALIZED_TEXT="default" ICON_SIZE="12.0 pt" COLOR="#000000" STYLE="combined" BORDER_WIDTH="3.0 px" MAX_WIDTH="10.1 cm" MIN_WIDTH="0.0 cm" VGAP_QUANTITY="6.8999999999999995 pt">
<font NAME="Noto Sans S Chinese Light" SIZE="12" BOLD="false" ITALIC="false"/>
<edge STYLE="sharp_bezier" WIDTH="7"/>
</stylenode>
<stylenode LOCALIZED_TEXT="defaultstyle.details" VGAP_QUANTITY="6.8999999999999995 pt">
<font NAME="Noto Sans S Chinese Light" SIZE="12"/>
</stylenode>
<stylenode LOCALIZED_TEXT="defaultstyle.attributes" VGAP_QUANTITY="6.8999999999999995 pt">
<font NAME="Noto Sans S Chinese Light" SIZE="12"/>
</stylenode>
<stylenode LOCALIZED_TEXT="defaultstyle.note" COLOR="#000000" BACKGROUND_COLOR="#ffffff" TEXT_ALIGN="LEFT" VGAP_QUANTITY="6.8999999999999995 pt">
<font NAME="Noto Sans S Chinese Light" SIZE="12"/>
</stylenode>
<stylenode LOCALIZED_TEXT="defaultstyle.floating" VGAP_QUANTITY="6.8999999999999995 pt">
<edge STYLE="hide_edge"/>
<cloud COLOR="#f0f0f0" SHAPE="ROUND_RECT"/>
<font NAME="Noto Sans S Chinese Light" SIZE="12"/>
</stylenode>
</stylenode>
<stylenode LOCALIZED_TEXT="styles.user-defined" POSITION="right" STYLE="bubble" VGAP_QUANTITY="6.8999999999999995 pt">
<font NAME="Noto Sans S Chinese Light" SIZE="12"/>
<stylenode LOCALIZED_TEXT="styles.ok" VGAP_QUANTITY="6.8999999999999995 pt">
<icon BUILTIN="button_ok"/>
<font NAME="Noto Sans S Chinese Light" SIZE="12"/>
</stylenode>
<stylenode LOCALIZED_TEXT="styles.needs_action" VGAP_QUANTITY="6.8999999999999995 pt">
<icon BUILTIN="messagebox_warning"/>
<font NAME="Noto Sans S Chinese Light" SIZE="12"/>
</stylenode>
<stylenode LOCALIZED_TEXT="styles.floating_node" VGAP_QUANTITY="6.8999999999999995 pt">
<edge STYLE="hide_edge"/>
<cloud COLOR="#f0f0f0" SHAPE="ROUND_RECT"/>
<font NAME="Noto Sans S Chinese Light" SIZE="12"/>
</stylenode>
<stylenode LOCALIZED_TEXT="styles.topic" COLOR="#18898b" STYLE="fork" VGAP_QUANTITY="6.8999999999999995 pt">
<font NAME="Noto Sans S Chinese Light" SIZE="12" BOLD="true"/>
</stylenode>
<stylenode LOCALIZED_TEXT="styles.subtopic" COLOR="#cc3300" STYLE="fork" VGAP_QUANTITY="6.8999999999999995 pt">
<font NAME="Noto Sans S Chinese Light" SIZE="12" BOLD="true"/>
</stylenode>
<stylenode LOCALIZED_TEXT="styles.subsubtopic" COLOR="#669900" VGAP_QUANTITY="6.8999999999999995 pt">
<font NAME="Noto Sans S Chinese Light" SIZE="12" BOLD="true"/>
</stylenode>
<stylenode LOCALIZED_TEXT="styles.connection" COLOR="#606060" STYLE="fork" VGAP_QUANTITY="6.8999999999999995 pt">
<font NAME="Noto Sans S Chinese Light" SIZE="12" BOLD="false"/>
<cloud COLOR="#f0f0f0" SHAPE="ROUND_RECT"/>
</stylenode>
<stylenode LOCALIZED_TEXT="styles.important" COLOR="#ff0000" VGAP_QUANTITY="6.8999999999999995 pt">
<icon BUILTIN="yes"/>
<font NAME="Noto Sans S Chinese Light" SIZE="12"/>
</stylenode>
<stylenode LOCALIZED_TEXT="styles.question" VGAP_QUANTITY="6.8999999999999995 pt">
<icon BUILTIN="help"/>
<font NAME="Noto Sans S Chinese Light" SIZE="12"/>
</stylenode>
<stylenode LOCALIZED_TEXT="styles.key" COLOR="#996600" VGAP_QUANTITY="6.8999999999999995 pt">
<icon BUILTIN="password"/>
<font NAME="Noto Sans S Chinese Light" SIZE="12" BOLD="false"/>
</stylenode>
<stylenode LOCALIZED_TEXT="styles.idea" VGAP_QUANTITY="6.8999999999999995 pt">
<icon BUILTIN="idea"/>
<font NAME="Noto Sans S Chinese Light" SIZE="12"/>
</stylenode>
<stylenode LOCALIZED_TEXT="styles.note" COLOR="#990000" VGAP_QUANTITY="6.8999999999999995 pt">
<font NAME="Noto Sans S Chinese Light" SIZE="12"/>
</stylenode>
<stylenode LOCALIZED_TEXT="styles.date" COLOR="#0033ff" VGAP_QUANTITY="6.8999999999999995 pt">
<icon BUILTIN="calendar"/>
<font NAME="Noto Sans S Chinese Light" SIZE="12"/>
</stylenode>
<stylenode LOCALIZED_TEXT="styles.website" COLOR="#006633" VGAP_QUANTITY="6.8999999999999995 pt">
<font NAME="Noto Sans S Chinese Light" SIZE="12"/>
</stylenode>
<stylenode LOCALIZED_TEXT="styles.list" COLOR="#cc6600" VGAP_QUANTITY="6.8999999999999995 pt">
<icon BUILTIN="list"/>
<font NAME="Noto Sans S Chinese Light" SIZE="12" BOLD="true"/>
</stylenode>
<stylenode LOCALIZED_TEXT="styles.quotation" COLOR="#338800" STYLE="fork" VGAP_QUANTITY="6.8999999999999995 pt">
<font NAME="Noto Sans S Chinese Light" SIZE="12" BOLD="false" ITALIC="false"/>
</stylenode>
<stylenode LOCALIZED_TEXT="styles.definition" COLOR="#666600" VGAP_QUANTITY="6.8999999999999995 pt">
<font NAME="Noto Sans S Chinese Light" SIZE="12" BOLD="false"/>
</stylenode>
<stylenode LOCALIZED_TEXT="styles.description" COLOR="#996600" VGAP_QUANTITY="6.8999999999999995 pt">
<font NAME="Noto Sans S Chinese Light" SIZE="12" BOLD="false"/>
</stylenode>
<stylenode LOCALIZED_TEXT="styles.pending" COLOR="#b3b95c" VGAP_QUANTITY="6.8999999999999995 pt">
<font NAME="Noto Sans S Chinese Light" SIZE="12"/>
</stylenode>
<stylenode TEXT="代码" COLOR="#c0fdce" BACKGROUND_COLOR="#000000" VGAP_QUANTITY="6.8999999999999995 pt">
<font NAME="Noto Sans S Chinese Light" SIZE="12"/>
</stylenode>
</stylenode>
<stylenode LOCALIZED_TEXT="styles.AutomaticLayout" POSITION="right" STYLE="bubble" VGAP_QUANTITY="6.8999999999999995 pt">
<font NAME="Noto Sans S Chinese Light" SIZE="12"/>
<stylenode LOCALIZED_TEXT="AutomaticLayout.level.root" COLOR="#000000" STYLE="oval" VGAP_QUANTITY="6.8999999999999995 pt">
<font NAME="Noto Sans S Chinese Light" SIZE="12"/>
<edge COLOR="#003333"/>
</stylenode>
<stylenode LOCALIZED_TEXT="AutomaticLayout.level,1" COLOR="#0033ff" VGAP_QUANTITY="6.8999999999999995 pt">
<font NAME="Noto Sans S Chinese Light" SIZE="12"/>
<edge COLOR="#808080"/>
</stylenode>
<stylenode LOCALIZED_TEXT="AutomaticLayout.level,2" COLOR="#003366" VGAP_QUANTITY="6.8999999999999995 pt">
<font NAME="Noto Sans S Chinese Light" SIZE="12"/>
<edge COLOR="#808080"/>
</stylenode>
<stylenode LOCALIZED_TEXT="AutomaticLayout.level,3" COLOR="#990000" VGAP_QUANTITY="6.8999999999999995 pt">
<font NAME="Noto Sans S Chinese Light" SIZE="12"/>
</stylenode>
<stylenode LOCALIZED_TEXT="AutomaticLayout.level,4" COLOR="#111111" VGAP_QUANTITY="6.8999999999999995 pt">
<font NAME="Noto Sans S Chinese Light" SIZE="12"/>
</stylenode>
<stylenode LOCALIZED_TEXT="AutomaticLayout.level,5" COLOR="#006666" VGAP_QUANTITY="6.8999999999999995 pt">
<font NAME="Noto Sans S Chinese Light" SIZE="12"/>
</stylenode>
<stylenode LOCALIZED_TEXT="AutomaticLayout.level,6" VGAP_QUANTITY="6.8999999999999995 pt">
<font SIZE="12"/>
</stylenode>
</stylenode>
</stylenode>
</map_styles>
</hook>
<hook NAME="AutomaticEdgeColor" COUNTER="101" RULE="ON_BRANCH_CREATION"/>
<hook NAME="accessories/plugins/AutomaticLayout.properties" VALUE="ALL"/>
<node TEXT="传统MMORPG服务器架构" POSITION="right" ID="ID_378479797" CREATED="1611558934452" MODIFIED="1614848926988">
<edge COLOR="#7c007c"/>
<node TEXT="结构" ID="ID_1462382922" CREATED="1611560293771" MODIFIED="1611560298877">
<node TEXT=" Gate1..N - Game1..N - World1" ID="ID_265811839" CREATED="1611558950613" MODIFIED="1611558959402"/>
<node TEXT=" Gate负责转发消息" ID="ID_397626418" CREATED="1611560250755" MODIFIED="1611560252083">
<node TEXT=" 接受客户端连接，客户端与服务器的通信桥接" ID="ID_643469201" CREATED="1614843943461" MODIFIED="1614844057950"/>
</node>
<node TEXT=" Game(Gas)对应游戏场景" ID="ID_1643223176" CREATED="1611560257131" MODIFIED="1611560318284">
<node TEXT=" 除World Server负责外的所有功能" ID="ID_718735518" CREATED="1614844140868" MODIFIED="1614844142375"/>
<node TEXT=" 角色移动与位置同步、技能战斗、AI、寻路、大部分任务系统功能" ID="ID_1684296161" CREATED="1614844142772" MODIFIED="1614844150526"/>
<node TEXT=" 不同Gas服务器上的玩家之间彼此之间的场景玩法及位置等信息完全隔离" ID="ID_1442491252" CREATED="1614844178836" MODIFIED="1614844183831"/>
</node>
<node TEXT=" World(Gcc)相当于场景调度管理器" ID="ID_1434773703" CREATED="1611560262964" MODIFIED="1611560324680">
<node TEXT=" 非游戏场景相关逻辑功能" ID="ID_1151486992" CREATED="1614844085572" MODIFIED="1614844086820">
<node TEXT=" 社交系统、聊天、部分社交任务" ID="ID_1229736321" CREATED="1614844100620" MODIFIED="1614844103340"/>
</node>
<node TEXT=" 游戏场景服务器的管理功能" ID="ID_1721801636" CREATED="1614844091828" MODIFIED="1614844092672">
<node TEXT=" 场景服务器发现、健康检查、启动/关闭" ID="ID_402570999" CREATED="1614844109144" MODIFIED="1614844110218"/>
</node>
</node>
</node>
<node TEXT=" 聊天服务器，拍卖行服务器，工会服务器等等拆分成独立的进程，不要耦合在World中" ID="ID_1356065173" CREATED="1611559068690" MODIFIED="1614849040222"/>
<node TEXT="问题" ID="ID_179484076" CREATED="1611558967332" MODIFIED="1611558969700">
<node TEXT=" 随着业务复杂度的增加，World需要管理的功能会越来越多" ID="ID_858786627" CREATED="1611558978900" MODIFIED="1611558993307"/>
<node TEXT=" 最后导致World成为系统的负载瓶颈并且极其庞杂难以维护" ID="ID_309020061" CREATED="1611558988924" MODIFIED="1611558990443"/>
</node>
<node TEXT="" ID="ID_1538792926" CREATED="1614828463189" MODIFIED="1614828466621">
<hook URI="MMO服务器架构_files/png_4732859084247929771.png" SIZE="0.48738244" NAME="ExternalObject"/>
</node>
</node>
<node TEXT="引入微服务" POSITION="right" ID="ID_1703381130" CREATED="1611559093235" MODIFIED="1611559103348">
<edge COLOR="#007c7c"/>
<node TEXT="特点" ID="ID_1672102811" CREATED="1611559110491" MODIFIED="1611559114108">
<node ID="ID_26530687" CREATED="1611559126582" MODIFIED="1611559126582"><richcontent TYPE="NODE">

<html>
  <head>
    
  </head>
  <body>
    <p>
      细粒度性，一个服务只专注于一件事。
    </p>
  </body>
</html>
</richcontent>
</node>
<node ID="ID_444496048" CREATED="1611559126582" MODIFIED="1611559126582"><richcontent TYPE="NODE">

<html>
  <head>
    
  </head>
  <body>
    <p>
      可组合性，易于重用已有的功能。
    </p>
  </body>
</html>
</richcontent>
</node>
<node ID="ID_1599516180" CREATED="1611559126584" MODIFIED="1611559126584"><richcontent TYPE="NODE">

<html>
  <head>
    
  </head>
  <body>
    <p>
      低耦合性，服务通常作为一个进程可单独部署
    </p>
  </body>
</html>
</richcontent>
</node>
</node>
<node TEXT="折分World服务" ID="ID_652570746" CREATED="1611559198218" MODIFIED="1611559208413">
<node TEXT=" 将游戏中独立的逻辑拆分成一个个微服务，然后服务与服务之间通过统一的接口来通信" ID="ID_1342999978" CREATED="1611559219922" MODIFIED="1611559221282"/>
<node TEXT="去中心化，没有World服务器了，所有的逻辑拆分到不同的服务中，可以轻松将区服承载扩展到万人同服的级别" ID="ID_1270253810" CREATED="1611559227805" MODIFIED="1611559229041"/>
<node TEXT=" 宕机带来的影响降到最低，它只会影响该服务所关联的功能" ID="ID_1572642531" CREATED="1611559233930" MODIFIED="1611559234804"/>
<node TEXT=" 由于服务带来的天然低耦合性，代码的清晰度和可维护性得到提高" ID="ID_923207557" CREATED="1611559239258" MODIFIED="1611559240452"/>
</node>
<node TEXT="微服务的问题" ID="ID_1883252090" CREATED="1611559247149" MODIFIED="1611559255988">
<node ID="ID_1734968819" CREATED="1611559277284" MODIFIED="1611559277284"><richcontent TYPE="NODE">

<html>
  <head>
    
  </head>
  <body>
    <p>
      微服务系统需要解决服务的注册以及发现问题。
    </p>
  </body>
</html>
</richcontent>
</node>
<node ID="ID_796350593" CREATED="1611559277284" MODIFIED="1611559277284"><richcontent TYPE="NODE">

<html>
  <head>
    
  </head>
  <body>
    <p>
      微服务系统需要解决服务与服务之间的通信问题
    </p>
  </body>
</html>
</richcontent>
</node>
<node ID="ID_898974693" CREATED="1611559277286" MODIFIED="1611559277286"><richcontent TYPE="NODE">

<html>
  <head>
    
  </head>
  <body>
    <p>
      微服务系统需要处理分布式系统相关的复杂性问题
    </p>
  </body>
</html>
</richcontent>
</node>
<node ID="ID_1275601267" CREATED="1611559277288" MODIFIED="1611559277288"><richcontent TYPE="NODE">

<html>
  <head>
    
  </head>
  <body>
    <p>
      微服务系统带来的部署和管理问题
    </p>
  </body>
</html>
</richcontent>
</node>
</node>
<node TEXT=" MMO服务器与Web服务器的对比" ID="ID_211224914" CREATED="1611559342145" MODIFIED="1611559364898">
<node TEXT=" 对于Web服务器来说他们的微服务架构可能需要管理成百上千的机器集群，而且相对来说更加注重系统的安全性和架构的平行扩展性" ID="ID_1348353937" CREATED="1611559376529" MODIFIED="1611559377710"/>
<node TEXT=" 而对于游戏服务器来说，它们通常是由一个个独立的游戏区服组成，区服与区服之间并无关联。即使是有跨服玩法也不过是确定的几个区服相连" ID="ID_1697728833" CREATED="1611559392337" MODIFIED="1611559393276"/>
<node TEXT="区别于Web服务器的是游戏服务器往往对延迟有着相对较高的要求，一般要求在100ms内响应客户端的请求" ID="ID_1192644474" CREATED="1611559408330" MODIFIED="1611559409749"/>
</node>
</node>
<node TEXT="MMO场景下的微服务架构设计" POSITION="right" ID="ID_1801901654" CREATED="1611559419616" MODIFIED="1611559424943">
<edge COLOR="#7c7c00"/>
<node TEXT=" 服务器创建" ID="ID_1271349088" CREATED="1611559818726" MODIFIED="1611559826815">
<node TEXT=" 服务的注册与发现问题" ID="ID_1026129347" CREATED="1611559848295" MODIFIED="1611559849290">
<node TEXT=" Web界因为面临的往往是海量的机器集群，所以业界采用的解决方案如zookeeper, consul, eureka等等通常是多台机器通过复杂的分布式一致性算法组成的注册中心来管理服务的注册与发现" ID="ID_1696852229" CREATED="1611559864549" MODIFIED="1611559865682"/>
<node TEXT="游戏服通常一个区服只需要一个注册中心就行了" ID="ID_915746657" CREATED="1611559890886" MODIFIED="1611559900928"/>
</node>
<node TEXT=" 当有了服务的注册与发现之后，微服务之间就可以通过获取服务的地址来进行通信了" ID="ID_1537970067" CREATED="1611559923789" MODIFIED="1611559925755"/>
<node TEXT=" 当某个操作需要关联多个服务的结果时，还往往需要有类似Task.WhenAll和Task.WhenAny这样的接口" ID="ID_1326876603" CREATED="1611559936639" MODIFIED="1611559941280"/>
</node>
<node TEXT=" 服务拆分" ID="ID_1183745413" CREATED="1611560363323" MODIFIED="1611560364461">
<node TEXT="" ID="ID_1930545711" CREATED="1611560458207" MODIFIED="1611560463261">
<hook URI="MMO服务器架构_files/png_3968286316445320227.png" SIZE="0.570057" NAME="ExternalObject"/>
</node>
<node TEXT=" MMO的游戏架构通常是基于场景划分的设计" ID="ID_1180119209" CREATED="1611560512586" MODIFIED="1611560524563"/>
<node TEXT=" 登录验证流程" ID="ID_742996401" CREATED="1611560547842" MODIFIED="1611560548767">
<node TEXT=" 客户端和登录服务器（Login)间的通讯" ID="ID_1079204207" CREATED="1611560554913" MODIFIED="1611560555858"/>
<node TEXT=" 流程" ID="ID_1420692293" CREATED="1611560572410" MODIFIED="1611560577706">
<node TEXT="登陆校验" ID="ID_777335535" CREATED="1611560720026" MODIFIED="1611560733652">
<node TEXT=" 校验和处理客户端的登录请求并记录当前登录的玩家" ID="ID_562300675" CREATED="1611560578018" MODIFIED="1611560580420"/>
<node TEXT=" 当客户端将id和key发送给登录服务器后，登录服务器会去运营商处申请校验客户端的登录数据" ID="ID_744187338" CREATED="1611560675625" MODIFIED="1611560677057"/>
</node>
<node TEXT="分配Gate" ID="ID_1963798999" CREATED="1611560740720" MODIFIED="1611560747469">
<node TEXT=" 收集网关服务器（Gate)的玩家数据，用于做负载均衡" ID="ID_1640724127" CREATED="1611560585641" MODIFIED="1611560586853"/>
<node TEXT=" 如果校验成功则根据Gate的负载信息挑选一个玩家数量较少的Gate让客户端去连接" ID="ID_27206198" CREATED="1611560688281" MODIFIED="1611560689294"/>
<node TEXT=" 此时该Gate会创建一个Player并设置State=WaitingForClient在一定时间内等待客户端连接进来" ID="ID_696648226" CREATED="1611560703864" MODIFIED="1611560705586"/>
<node TEXT=" 当客户端连接Gate成功后，登录流程结束" ID="ID_1188325500" CREATED="1611560709785" MODIFIED="1611560714387"/>
</node>
<node TEXT=" 划分出了Login，Gate这两个Service" ID="ID_1132425708" CREATED="1611560779513" MODIFIED="1611560780785"/>
</node>
<node TEXT=" Login" ID="ID_469000704" CREATED="1611560817858" MODIFIED="1611560820529">
<node TEXT=" LoginService负责验证客户端登录和协调GateService" ID="ID_1917057362" CREATED="1611560833400" MODIFIED="1611560834325"/>
</node>
<node TEXT=" Gate" ID="ID_1203366322" CREATED="1611560821035" MODIFIED="1611560826719">
<node TEXT=" GateService管理多个游戏玩家并负责数据转发" ID="ID_1252848120" CREATED="1611560839105" MODIFIED="1611560839944"/>
</node>
</node>
<node TEXT=" 游戏流程" ID="ID_434043753" CREATED="1611560889679" MODIFIED="1611560910161">
<node TEXT=" 选角状态中，Player会从数据库中读取角色的基本信息发送给客户端" ID="ID_1959501169" CREATED="1611560929424" MODIFIED="1611560938829"/>
<node TEXT=" 当客户端确认选择角色后，此时Player读取角色的完整信息并准备进入游戏场景" ID="ID_200138986" CREATED="1611561981875" MODIFIED="1611561983135"/>
<node TEXT=" Player会根据角色之前保存的场景id向场景管理服务请求进入该场景" ID="ID_1805136785" CREATED="1611561991604" MODIFIED="1611561992655"/>
<node TEXT=" 场景管理服务会挑选一个分线人数未满的场景为玩家进入场景" ID="ID_1368746704" CREATED="1611561998228" MODIFIED="1611561999270"/>
<node TEXT="三个服务" ID="ID_1513017671" CREATED="1611562057347" MODIFIED="1611562060348">
<node TEXT=" Scene,SceneManager,DB" ID="ID_1390538581" CREATED="1611562061110" MODIFIED="1611562066996"/>
</node>
</node>
<node TEXT="可拆模块" ID="ID_1434374964" CREATED="1611562127122" MODIFIED="1611562133916">
<node TEXT=" 好友，聊天，拍卖行，排行榜，竞技场，邮件，帮派" ID="ID_950619045" CREATED="1611562134563" MODIFIED="1611562135957"/>
</node>
<node TEXT=" 对比Web界经典的微服务框架" ID="ID_1006852307" CREATED="1611562259329" MODIFIED="1611562295883">
<node TEXT=" 不需要多点服务注册和发现中心，在分区服的场景下单点就足够了" ID="ID_1513483652" CREATED="1611562302202" MODIFIED="1611562303113"/>
<node TEXT=" 由于MMO游戏中尤其是实时战斗需要保证低延迟的体验，所以通常会有一个场景服务来管理角色战斗相关的所有功能" ID="ID_1644602808" CREATED="1611562312466" MODIFIED="1611562314007"/>
<node TEXT=" 游戏中的流量变化主要受玩家战斗行为影响，其他服务不会出现流量过载问题，所以一般在逻辑层做优化处理就行了。不需要在底层引入服务熔断和降级机制" ID="ID_1091321149" CREATED="1611562328554" MODIFIED="1611562329566"/>
</node>
</node>
</node>
<node TEXT=" 游戏中的Redis" POSITION="right" ID="ID_1497828626" CREATED="1614825638044" MODIFIED="1614825663383">
<edge COLOR="#ff0000"/>
<node TEXT="用途" ID="ID_1752205635" CREATED="1614827793356" MODIFIED="1614827795372">
<node TEXT=" Cache" ID="ID_809019816" CREATED="1614825829539" MODIFIED="1614825830768">
<node TEXT=" 很多逻辑如果去读mongodb，会有性能问题，所以使用redis作为缓存，降低对mongodb的读写" ID="ID_276178740" CREATED="1614825847924" MODIFIED="1614825850086"/>
<node TEXT="热数据放在Redis里，提高访问效率" ID="ID_585152449" CREATED="1614825867907" MODIFIED="1614825875023"/>
<node TEXT="热数据主要是数据量小、数据访问量高" ID="ID_1071816193" CREATED="1614826032816" MODIFIED="1615279513774"/>
</node>
<node TEXT=" 无状态服务开发支持" ID="ID_392780000" CREATED="1614826064208" MODIFIED="1614826074435">
<node TEXT="有无状态" ID="ID_1680321849" CREATED="1614826090904" MODIFIED="1614826094082">
<node TEXT=" 一般游戏服务器都是有状态的，也就是说内存里是有数据的" ID="ID_552673181" CREATED="1614826094424" MODIFIED="1614826103002"/>
<node TEXT=" 无状态的服务的意思是内存里不保存数据（有可能在执行逻辑过程中有些临时变量）" ID="ID_1027692565" CREATED="1614826116600" MODIFIED="1614826117981"/>
</node>
<node TEXT="进程有状态，性能瓶颈在单个进程上，不利扩展" ID="ID_1439371320" CREATED="1614827255824" MODIFIED="1614827308648"/>
<node TEXT="redis保存状态，其它进程无状态 ，可以写多个进程来执行业务逻辑。" ID="ID_670643447" CREATED="1614827173551" MODIFIED="1614827468482"/>
<node TEXT=" 数据放在内存里，机器和进程是有概率crash，数据也就丢失了。而redis可以使用主从切换，数据不会丢失，容错能力强" ID="ID_696936530" CREATED="1614827353742" MODIFIED="1614827354824"/>
<node TEXT="缺点是编程会麻烦一点" ID="ID_465135408" CREATED="1614827370614" MODIFIED="1614827381536"/>
</node>
<node TEXT="临时数据管理" ID="ID_1684581023" CREATED="1614827534503" MODIFIED="1614827542439">
<node TEXT=" redis的数据支持生命周期" ID="ID_1790596699" CREATED="1614827554868" MODIFIED="1614827555831"/>
<node TEXT=" 通过EXPIRE命令设置生存时间" ID="ID_1890922720" CREATED="1614827619107" MODIFIED="1614827620477"/>
<node TEXT=" 若一些数据是临时的（比如活动数据），到期会自动删除" ID="ID_1244493244" CREATED="1614827581115" MODIFIED="1614827632926"/>
</node>
<node TEXT=" 排行榜" ID="ID_1873091583" CREATED="1614827388493" MODIFIED="1614827512446">
<node TEXT=" Redis的SortedSet非常适合做排行榜功能" ID="ID_284323971" CREATED="1614827519741" MODIFIED="1614827521480"/>
<node ID="ID_1046192182" CREATED="1615279045142" MODIFIED="1615279045142"><richcontent TYPE="NODE">

<html>
  <head>
    
  </head>
  <body>
    <p>
      有序集合的成员是唯一的,但分数(score)却可以重复。
    </p>
  </body>
</html>

</richcontent>
</node>
<node TEXT="redis sorted sets里面当items内容大于64的时候同时使用了hash和skiplist两种设计实现" ID="ID_972214332" CREATED="1615279045142" MODIFIED="1615279108489"/>
<node TEXT=" 添加和删除都需要修改skiplist，所以复杂度为O(log(n))" ID="ID_1103761912" CREATED="1615279120460" MODIFIED="1615279121392"/>
<node TEXT=" 查找元素的话可以直接使用hash，其复杂度为O(1)" ID="ID_751388826" CREATED="1615279127812" MODIFIED="1615279129152"/>
</node>
<node TEXT=" 分布式锁" ID="ID_432883824" CREATED="1614827649243" MODIFIED="1614827650074">
<node TEXT="Redis是单线程的，基于redis的SETNX命令实现" ID="ID_1053458532" CREATED="1614827862690" MODIFIED="1614827874205"/>
<node TEXT=" 不同进程中的逻辑可使用Redis作锁写同步逻辑" ID="ID_1061392993" CREATED="1614827655827" MODIFIED="1614827904475"/>
</node>
<node TEXT=" 消息队列" ID="ID_457990148" CREATED="1614827841810" MODIFIED="1614827842978">
<node TEXT=" 游戏中不同的进程之间的通信，也可以使用redis作为消息队列来通信" ID="ID_358042308" CREATED="1614827914978" MODIFIED="1614827915864"/>
<node TEXT=" 比如给游戏服务器发一个控制命令，就可以将命令存在redis的list中，游戏服务器实时检查redis是否有命令，有则pop出来执行" ID="ID_711618237" CREATED="1614827934322" MODIFIED="1614827936028"/>
</node>
</node>
<node TEXT=" 注意事项" ID="ID_1431788551" CREATED="1614827805618" MODIFIED="1614827813173">
<node TEXT=" 避免出现大key" ID="ID_326067392" CREATED="1614827834091" MODIFIED="1614828089879">
<node TEXT=" 大key表示一个key对应的value非常大" ID="ID_1080301148" CREATED="1614828073633" MODIFIED="1614828074710"/>
<node TEXT="  原因是redis基于key来做的分布式，若创建了一个大key，就会导致分布式功能失效，所有的请求都会到达同一个redis节点，导致这个节点卡顿，其他节点空闲" ID="ID_1820992354" CREATED="1614828115594" MODIFIED="1614828116983"/>
<node TEXT=" 通过小key进行分散" ID="ID_1942672216" CREATED="1614828090864" MODIFIED="1614828211386"/>
<node TEXT=" Bigkey没办法检测" ID="ID_1131104684" CREATED="1614828184832" MODIFIED="1614828185793"/>
</node>
<node TEXT=" 避免hotkey" ID="ID_1497118953" CREATED="1614828158601" MODIFIED="1614828159970">
<node TEXT=" hotkey的含义是某个key读写频率很高，特别繁忙" ID="ID_1116324672" CREATED="1614828166433" MODIFIED="1614828167394"/>
<node TEXT=" 需要避免这种情况的原因和大key类似，会导致分布式失效，某些节点卡顿" ID="ID_1216108850" CREATED="1614828172970" MODIFIED="1614828173798"/>
<node TEXT=" hotkey在Redis4.0版本有检测方式" ID="ID_576803960" CREATED="1614828177728" MODIFIED="1614828178551"/>
</node>
<node TEXT=" 给key增加前缀" ID="ID_348910375" CREATED="1614828193032" MODIFIED="1614828194219">
<node TEXT=" 创建一个新的key前，需要保证key在所有业务中是独一无二的" ID="ID_127761190" CREATED="1614828205144" MODIFIED="1614828206190"/>
<node TEXT=" 带命名空间的key" ID="ID_1222943069" CREATED="1614828213121" MODIFIED="1614828217674"/>
</node>
<node TEXT=" redis冷热数据分离" ID="ID_1878634982" CREATED="1614828225217" MODIFIED="1614828226131">
<node TEXT=" Redis不适合做大数据的持久化存储，因为Redis会将所有数据都放在内存里" ID="ID_455589229" CREATED="1614828247808" MODIFIED="1614828248769"/>
<node TEXT=" 冷数据(长时间不活跃的数据，比如流失玩家数据)" ID="ID_747904420" CREATED="1614828270215" MODIFIED="1614828300364"/>
<node TEXT=" 热数据（活跃数据，比如经常登录玩家信息）" ID="ID_454736642" CREATED="1614828279424" MODIFIED="1614828280597"/>
<node TEXT=" 将冷数据放在硬盘里，将热数据放在内存里" ID="ID_1211710064" CREATED="1614828308336" MODIFIED="1614828309432"/>
</node>
</node>
</node>
<node TEXT="游戏服务器对比web服务器" POSITION="right" ID="ID_199278156" CREATED="1614850692321" MODIFIED="1614850703460">
<edge COLOR="#0000ff"/>
<node TEXT="http与socket" ID="ID_537696020" CREATED="1615272277929" MODIFIED="1615272286498">
<node TEXT="web应用" ID="ID_10901084" CREATED="1615272492462" MODIFIED="1615272495361">
<node TEXT=" web服务器的本质是http服务器" ID="ID_883273294" CREATED="1615272126469" MODIFIED="1615272127841"/>
<node TEXT=" web应用都是基于request/response的短连接模式" ID="ID_1187398687" CREATED="1615272196709" MODIFIED="1615272197934"/>
<node TEXT=" web服务器更看重高吞吐能力，会使用多层，并增加io的方法，来提升吞吐能力，但是相应的，latency会被拉高" ID="ID_907222745" CREATED="1615276615709" MODIFIED="1615276760271"/>
</node>
<node TEXT="游戏" ID="ID_1914804918" CREATED="1615272499678" MODIFIED="1615272502792">
<node TEXT=" 游戏服务器的本质就是socket服务器，利用socket通讯来实现服务器与客户端之间的交互" ID="ID_351347285" CREATED="1615272133613" MODIFIED="1615276975571"/>
<node TEXT="两端连接成功时，应用程序两端都会产生一个Socket实例，操作这个实例，完成所需的会话" ID="ID_1263605854" CREATED="1615272149684" MODIFIED="1615277028407"/>
<node TEXT=" 有不少游戏是直接基于原生socket来开发的" ID="ID_1735518682" CREATED="1615272173061" MODIFIED="1615272174221"/>
<node TEXT=" 游戏服务器更看重低延迟，io就只有一层，客户端到服务器端，然后服务器端不会在网络上再做分层。" ID="ID_1489655304" CREATED="1615276639548" MODIFIED="1615276808248"/>
<node TEXT=" io是latency的天敌，io只要每增加一层，latency就会被放大一倍" ID="ID_1725269355" CREATED="1615276809004" MODIFIED="1615276809839"/>
</node>
</node>
<node TEXT="长连接与短连接" ID="ID_1544660103" CREATED="1615272294414" MODIFIED="1615272308520">
<node TEXT=" web应用" ID="ID_1741006827" CREATED="1615272338622" MODIFIED="1615272352081">
<node TEXT=" 基于request/response的短连接模式" ID="ID_936771415" CREATED="1615272352743" MODIFIED="1615272418718"/>
<node TEXT="原因" ID="ID_195291876" CREATED="1615272394902" MODIFIED="1615272398985">
<node TEXT=" 通讯的单向性，普通web应用一般只有拉模式" ID="ID_1527836561" CREATED="1615272414343" MODIFIED="1615272415677"/>
<node TEXT=" 响应的实时性要求不高，一般web应用的响应时间在3秒以内都算响应比较及时的" ID="ID_684366646" CREATED="1615272425127" MODIFIED="1615272427006"/>
</node>
<node TEXT="好处" ID="ID_961139254" CREATED="1615272399838" MODIFIED="1615272402545">
<node TEXT=" 占用的资源要比一直hold长连接的游戏服务器要少很多" ID="ID_201088438" CREATED="1615272409470" MODIFIED="1615272410718"/>
<node TEXT=" web应用可以使用基于http的短连接来达到最大的可扩展性" ID="ID_1245454192" CREATED="1615272372870" MODIFIED="1615272373917"/>
</node>
</node>
<node TEXT="游戏" ID="ID_1078162455" CREATED="1615272430607" MODIFIED="1615272436120">
<node TEXT=" 游戏应用只能使用长连接" ID="ID_555455929" CREATED="1615272444497" MODIFIED="1615272446420"/>
<node TEXT="原因" ID="ID_915072695" CREATED="1615272454198" MODIFIED="1615272459912">
<node TEXT=" 通讯的双向性，游戏应用不仅仅是推拉模式，而且推送的数据量要远远大于拉的数据量" ID="ID_1017976688" CREATED="1615272463022" MODIFIED="1615272464297"/>
<node TEXT=" 响应的实时性要求极高，一般游戏应用要求推送的消息实时反应，而实时响应的最大时间是100ms" ID="ID_1485825644" CREATED="1615272465223" MODIFIED="1615272472920"/>
</node>
</node>
</node>
<node TEXT=" 分区策略与负载均衡" ID="ID_1424800933" CREATED="1615273149339" MODIFIED="1615273151643">
<node TEXT=" web应用" ID="ID_606489232" CREATED="1615273160818" MODIFIED="1615273161949">
<node TEXT=" web应用的分区可以根据负载均衡自由决定" ID="ID_758278374" CREATED="1615273174666" MODIFIED="1615273175933"/>
<node TEXT=" 普通的web应用在交互上没有相邻性的概念，所有用户之间的交互都是平等，交互频率也不受地域限制" ID="ID_1895201995" CREATED="1615273287473" MODIFIED="1615273290144"/>
</node>
<node TEXT=" 游戏" ID="ID_705158244" CREATED="1615273210250" MODIFIED="1615273219612">
<node TEXT=" 游戏是基于场景(area)的分区模式" ID="ID_207719574" CREATED="1615273227386" MODIFIED="1615273231832"/>
<node TEXT=" 同场景的玩家跑在一个进程内， 以达到最少的跨进程调用。场景进程是带状态的，伸缩性受限制" ID="ID_1895543430" CREATED="1615273239793" MODIFIED="1615273396347"/>
<node TEXT=" 游戏交互跟玩家所在地图（场景）上的位置关系非常大，且交互频率高，并且要求实时性" ID="ID_1191631689" CREATED="1615273303864" MODIFIED="1615273335059"/>
</node>
</node>
<node TEXT=" 可伸缩性与分布式开发" ID="ID_1525544849" CREATED="1615273426487" MODIFIED="1615273427913">
<node TEXT=" 单进程的架构" ID="ID_104114502" CREATED="1615274253070" MODIFIED="1615274254242">
<node TEXT=" 所有的逻辑都在单台服务器内完成" ID="ID_410736889" CREATED="1615274260399" MODIFIED="1615274261361"/>
<node TEXT=" 对于同时在线要求不高的游戏是可以这么做的" ID="ID_1421601926" CREATED="1615274266670" MODIFIED="1615274268303"/>
<node TEXT=" 由于同时在线人数的上升， 单服务器的可伸缩性必然受到挑战" ID="ID_1519164517" CREATED="1615274293335" MODIFIED="1615274294282"/>
</node>
<node TEXT=" web很少需要分布式开发" ID="ID_1291654760" CREATED="1615274302294" MODIFIED="1615274366717">
<node TEXT=" web服务器的无状态性" ID="ID_1151471979" CREATED="1615274320478" MODIFIED="1615274321721"/>
<node TEXT=" 只需要通过前端的负载均衡器可以导向任意一个进程" ID="ID_1976817715" CREATED="1615274373509" MODIFIED="1615274374765"/>
</node>
<node TEXT=" 游戏服务器是一个标准的分布式开发架构" ID="ID_1584285477" CREATED="1615274381469" MODIFIED="1615274398050">
<node TEXT=" 蜘蛛网式的架构，每个进程都有各自的职责" ID="ID_983617376" CREATED="1615274411253" MODIFIED="1615274412431"/>
<node TEXT=" 这些进程的交织在一起共同完成一件任务" ID="ID_1604633976" CREATED="1615274418078" MODIFIED="1615274418972"/>
</node>
</node>
<node TEXT="分布式开发难点" ID="ID_1534517627" CREATED="1615274960225" MODIFIED="1615274967748">
<node TEXT=" 多进程（服务器）的管理" ID="ID_749128135" CREATED="1615274973442" MODIFIED="1615274974584">
<node TEXT=" 通常的游戏服务器要由很多进程共同去完成任务" ID="ID_1131985078" CREATED="1615275053082" MODIFIED="1615275054626"/>
<node TEXT=" 如果没有统一的抽象与管理，光把这些开发环境的进程启动起来就是非常复杂的工作" ID="ID_881392981" CREATED="1615275070681" MODIFIED="1615275074369"/>
<node TEXT=" 进程的启动与重启就将严重影响开发效率" ID="ID_1530056358" CREATED="1615275080914" MODIFIED="1615275082087"/>
<node TEXT=" 多进程间的调试并不容易， 发现一个bug就要跨好几个进程" ID="ID_1650712788" CREATED="1615275090944" MODIFIED="1615275093587"/>
</node>
<node TEXT="分布式事务、异步化操作" ID="ID_1003016328" CREATED="1615275100529" MODIFIED="1615275132570">
<node TEXT=" 尽管我们尽量把逻辑放在一个进程里处理，但分布式事务仍然是不可避免的" ID="ID_1452311571" CREATED="1615275149521" MODIFIED="1615275150582"/>
<node TEXT=" 两阶段提交的代码，异步化的操作在普通的开发语言里并不是容易的事" ID="ID_809225489" CREATED="1615275174288" MODIFIED="1615275175552"/>
</node>
<node TEXT=" 负载均衡，高可用" ID="ID_1956069353" CREATED="1615275182256" MODIFIED="1615275183441">
<node TEXT=" 对于有些无状态的服务器，我们则可以把请求路由到负载最低的服务器" ID="ID_713709942" CREATED="1615275198525" MODIFIED="1615275199712"/>
<node TEXT=" 通常对于无状态的服务器， 高可用是比较好做的" ID="ID_1025251217" CREATED="1615275210240" MODIFIED="1615275211541"/>
<node TEXT=" 由于游戏服务器的有状态性，很多请求需要通过特定的路由规则导到某台服务器" ID="ID_1441144907" CREATED="1615275191632" MODIFIED="1615275192764"/>
<node TEXT=" 对于有状态的服务器，要做高可用会非常困难" ID="ID_24224842" CREATED="1615275225912" MODIFIED="1615275226872"/>
</node>
<node TEXT="高可用状态服务器" ID="ID_285003289" CREATED="1615275233384" MODIFIED="1615275243034">
<node TEXT=" 将状态引出到外存" ID="ID_1037267866" CREATED="1615275248312" MODIFIED="1615275249275">
<node TEXT=" 例如将状态引到redis， 这样进程本身就可以无状态了" ID="ID_514859067" CREATED="1615275257266" MODIFIED="1615275275043"/>
<node TEXT=" 但由于所有的操作都通过redis可能带来性能损耗，有些场景是不能承受这些损耗的" ID="ID_1393149928" CREATED="1615275289017" MODIFIED="1615275290465"/>
</node>
<node TEXT=" 通过进程互备" ID="ID_1798715960" CREATED="1615275332000" MODIFIED="1615275333621">
<node TEXT=" 将状态通过日志等方式同步到另一进程" ID="ID_1743280254" CREATED="1615275360112" MODIFIED="1615275361154"/>
<node TEXT=" 可能存在着瞬间数据丢失的问题" ID="ID_879943392" CREATED="1615275370312" MODIFIED="1615275371282"/>
<node TEXT=" 这种数据丢失在一些应用场景可能毫无问题， 但在另外一些应用场景可能引起严重的数据不一致" ID="ID_450062172" CREATED="1615275382280" MODIFIED="1615275383176"/>
</node>
</node>
</node>
<node TEXT=" 原生socket开发的问题" ID="ID_926024268" CREATED="1615275412460" MODIFIED="1615275413379">
<node TEXT=" 抽象程度过低" ID="ID_832982311" CREATED="1615275434104" MODIFIED="1615275443589">
<node TEXT=" 原生的socket抽象程度过低，接口过于底层" ID="ID_324236527" CREATED="1615275451280" MODIFIED="1615275452111"/>
<node TEXT=" 很多机制都需要自己封装，如Session、filter、请求抽象、广播等机制都要自已实现" ID="ID_1500356658" CREATED="1615275464168" MODIFIED="1615275464928"/>
</node>
<node TEXT=" 可伸缩性" ID="ID_481134005" CREATED="1615275469783" MODIFIED="1615275470523">
<node TEXT=" 高可伸缩性需考虑很多问题，消息密度、存储策略、进程架构等因素都需要考虑" ID="ID_831081029" CREATED="1615275478040" MODIFIED="1615275478991"/>
<node TEXT=" 用原生的socket要达到高可伸缩性，需要在架构上花费大量的功夫，而且效果也未必能达到开源框架的水准" ID="ID_1092823765" CREATED="1615275479543" MODIFIED="1615275489306"/>
</node>
<node TEXT=" 服务端的监控管理" ID="ID_1084009704" CREATED="1615275495599" MODIFIED="1615275497423">
<node TEXT=" 很多服务器的数据需要监控" ID="ID_799308923" CREATED="1615275504647" MODIFIED="1615275505739"/>
<node TEXT=" 例如消息密度、在线人数、机器压力、网络压力等" ID="ID_677757019" CREATED="1615275511111" MODIFIED="1615275512053"/>
<node TEXT=" 如果采用原生socket，所有这些都要自己开发，代价很大" ID="ID_1182584443" CREATED="1615275516463" MODIFIED="1615275517338"/>
</node>
</node>
</node>
</node>
</map>
